<!DOCTYPE html>
<html>
	<head>
		<title>Lynx Dev</title>
		<link href="w3.css" rel="stylesheet" />
		<style>
			body { font-family: "Roboto", sans-serif !important; }
		</style>
		<meta charset="utf8" />
	</head>

	<body class="animate-opacity">
		<div class="padding">
			<a href="javascript:history.back();">&lt; back</a>
			<h2>In Device</h2>

			<div id="device-info">
			</div>

			<button onclick="log.innerText += '\n' + Android.stopWSClient();">Close Connection</button>
			<button onclick="log.innerText += '\n' + Android.sendWSText('MISAKA');">ONEE-SAMA~!</button>
			<button onclick="Android.startScreenStream();">Start Screen Streaming</button>

			<pre class="padding margin-top margin-bottom light-grey" style="height: calc(100vh - 370px); overflow: scroll;" id="log"></pre class="padding margin-top margin-bottom">
		</div>

		<script>
			function SaferHTML(templateData) {
				var s = templateData[0];
				for (var i = 1; i < arguments.length; i++) {
					var arg = String(arguments[i]);

					// Escape special characters in the substitution.
					s += arg.replace(/&/g, "&amp;")
									.replace(/</g, "&lt;")
									.replace(/>/g, "&gt;");

					// Don't escape special characters in the template.
					s += templateData[i];
				}
				return s;
			}
		</script>

		<script>
			const log = document.getElementById("log");
			const infoDiv = document.getElementById("device-info");
			let data = atob(window.location.hash.replace("#", ""));
			
			Android.writeSettings("{}");

			// this page should:
			// start the background service (WebSocket Client)
			// start screen capturing (with appropriate permissions code on the Java side)

			function onload() {
				log.innerText += "\n" + data; // get data from previous page
				
				try { data = JSON.parse(data); }
				catch (e) {
					infoDiv.innerText = "BEEP BEEP BEEP, DATA WAS MALFORMED. DID YOU SCAN THE CORRECT QR CODE?";
					return;
				}

				infoDiv.innerHTML = SaferHTML`
					<b>Device IP: </b> ${data.ip}<br>
					<b>Token: </b> ${data.connectionToken}`;

				log.innerText += "\n" + Android.startWSClient(data.ip + ":57531", data.connectionToken);
				// log.innerText += "\n" + "Requesting permissions...";
				// log.innerText += "\n" + Android.checkPermissions();
			}

			function htmlLog(data) { log.innerText += "\n" + data; }

			onload();
		</script>
	</body>
</html>