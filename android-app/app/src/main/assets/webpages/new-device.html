<!DOCTYPE html>
<html>
	<head>
		<title>Lynx Dev</title>
		<link href="w3.css" rel="stylesheet" />
		<style>
			body { font-family: "Roboto", sans-serif !important; }
		</style>
		<meta charset="utf8" />
	</head>

	<body class="animate-opacity">
		<div class="padding">
			<a href="javascript:history.back();">&lt; back</a>
			<h2>Setup New Device</h2>

			<div id="device-info">
			</div>

			<div id="device-setup" style="display: none;">
				<b>Desired Capabilities:</b>
				<div><input type="checkbox" id="setup-screenmirror" /> <label for="setup-screenmirror">Screen Mirroring</label></div>
				<div><input type="checkbox" id="setup-remotecontrol" /> <label for="setup-remotecontrol">Remote Control from PC</label></div>
				<div><input type="checkbox" id="setup-filetransfer" /> <label for="setup-filetransfer">File Transfer</label></div>
				<div><input type="checkbox" id="setup-filebrowse" /> <label for="setup-filebrowse">Full Filesystem Browsing</label></div>

				<button onclick="setupContinue();">OK</button>
				<button onclick="history.back();">Cancel</button>
			</div>

			<pre class="padding margin-top margin-bottom light-grey" style="height: calc(100vh - 370px); overflow: scroll;" id="log"></pre class="padding margin-top margin-bottom">
		</div>

		<script>
			function SaferHTML(templateData) {
				var s = templateData[0];
				for (var i = 1; i < arguments.length; i++) {
					var arg = String(arguments[i]);

					// Escape special characters in the substitution.
					s += arg.replace(/&/g, "&amp;")
									.replace(/</g, "&lt;")
									.replace(/>/g, "&gt;");

					// Don't escape special characters in the template.
					s += templateData[i];
				}
				return s;
			}
		</script>

		<script>
			const log = document.getElementById("log");
			const infoDiv = document.getElementById("device-info");
			let data = atob(window.location.hash.replace("#", ""));

			function onload() {
				log.innerText += "\n" + data; // get data from previous page
				
				try { data = JSON.parse(data); }
				catch (e) {
					infoDiv.innerText = "BEEP BEEP BEEP, DATA WAS MALFORMED. DID YOU SCAN THE CORRECT QR CODE?";
					return;
				}

				infoDiv.innerHTML = SaferHTML`
					<b>Device IP: </b> ${data.ip}<br>
					<b>Token: </b> ${data.connectionToken}`;

				document.getElementById("device-setup").style.display = "block";
			}

			function setupContinue() {
				Android.writeSettings(JSON.stringify({
					index_redirect: "in-device.html" + window.location.hash
				}));
				window.history.go(-1);
			}

			onload();
		</script>
	</body>
</html>